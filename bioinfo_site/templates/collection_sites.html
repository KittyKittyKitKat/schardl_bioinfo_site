{# Copyright (c) 2023 Nyx Harris-Palmer, Tharanie Subramaniam #}
{# TODO: switch table for accordion layout #}
{# TODO: topo view default #}
{# TODO: eco regions data to each row #}
{# indiana region 71c #}
{#
the main site has a few links, but I would recommend looking for more on OpenStreetMap in searches. I attach a link to the tagged features page on the wiki, it may be possible to recreate this or use created layers to define collection sites, ecoregions, etc.
https://www.openstreetmap.org/#map=10/38.0259/-84.6023

https://wiki.openstreetmap.org/wiki/Map_features

#}
{# https://opengisdata.ky.gov/datasets/kygeonet::ky-level-iv-ecoregions/about look for citing #}
{% extends "layout.html" %}
{% block extra_head %}
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin="">
</script>
<style>
  #map {
    height: 400px;
    width: 100%;
    border: 1px solid black;
    border-radius: 5px;
  }

  img.huechange {
    filter: hue-rotate(150deg);
  }
</style>
{% endblock extra_head %}
{% block content %}
<div class="container-fluid">
 <div class="row">
    <div class="col-md-6 order-md-last">
      <div id="map"></div>
    </div>

    <div class="col-md-6">
      <div id="marker-table" class="table-responsive">
        <table class="table table-bordered caption-top table-hover">
          {% if view == 'plants' %}
            <caption>
              List of plant sites.
              View
              <a
                href="#"
                onclick="window.location.replace('{{ url_for('routes.collection_sites', view='collection') }}');"
              >collection sites</a>.
            </caption>
          {% else %}
            <caption>
              List of collection sites.
              View
              <a
                href="#"
                onclick="window.location.replace('{{ url_for('routes.collection_sites', view='plants') }}');"
              >plant sites</a>.
            </caption>
          {% endif %}
          <thead>
            <tr>
              {% for fieldname in fieldnames %}
              <th scope="col" class="text-center">{{ fieldname }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
          {% for row in markers %}
            <tr>
            {% for key, value in row.items() %}
              <td>{{value}}</td>
            {% endfor %}
            <td>
              <button
                type="button"
                class="btn btn-secondary btn-sm"
                onclick="viewMapMarker({{ row['Latitude'] }}, {{ row['Longitude'] }})"
              >
                View on map
              </button>
            </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  function set_map_table_height() {
      let window_height = window.innerHeight;
      let nav_height = document.querySelector('#site-navbar').offsetHeight;
      document.querySelector("#map").style.height = (
        window_height-nav_height-15
      ) + 'px';
      document.querySelector("#marker-table").style.height = (
        window_height-nav_height-15
      ) + 'px';
  }
  set_map_table_height();
  window.addEventListener('resize', set_map_table_height);

  let map = L.map('map', {
    "center": [38.047989, -84.501640],
    "zoom": 8,
  });

  let Esri_WorldImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
  });

  let Esri_WorldTopoMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
    attribution: 'Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ, TomTom, Intermap, iPC, USGS, FAO, NPS, NRCAN, GeoBase, Kadaster NL, Ordnance Survey, Esri Japan, METI, Esri China (Hong Kong), and the GIS User Community'
  });

  let Esri_WorldStreetMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
    attribution: 'Tiles &copy; Esri &mdash; Source: Esri, DeLorme, NAVTEQ, USGS, Intermap, iPC, NRCAN, Esri Japan, METI, Esri China (Hong Kong), Esri (Thailand), TomTom, 2012'
  });

  let layerControl = L.control.layers(
    {
      "Satellite": Esri_WorldImagery,
      "Topography": Esri_WorldTopoMap,
      "Streets": Esri_WorldStreetMap,
    },
  ).addTo(map);

  Esri_WorldTopoMap.addTo(map);

  let markers = {{ markers|tojson }}; // Array of Objects
  let zoom_level = {{16 if view == 'plants' else 12}};

  let markers_arr = [];
  markers.forEach(function (item, index) {
    let marker = L.marker([item.Latitude, item.Longitude]).addTo(map);
    {{ 'marker._icon.classList.add("huechange");' | safe if view == 'plants' else '' }}
    marker.bindPopup(
      `${item.Site} (${item.Abbreviation})<br>${item.County} County, ${item.State}<br>(${item.Latitude}, ${item.Longitude})`
    );
    marker.on('click', () => map.flyTo(marker.getLatLng(), zoom_level));
    markers_arr.push(marker);
  });

  function viewMapMarker(lat, long) {
    let ll = L.latLng(lat, long)
    map.closePopup();
    map.flyTo(ll, zoom_level);
    for (let i in markers_arr) {
      if (markers_arr[i].getLatLng().equals(ll)) {
        markers_arr[i].openPopup();
        return;
      }
    }
  }
</script>
{% endblock content %}