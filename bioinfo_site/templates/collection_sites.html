{# Copyright (c) 2023 Nyx Harris-Palmer, Tharanie Subramaniam #}
{% extends "layout.html" %}
{% block extra_head %}
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin="">
</script>
<style>
  #map {
    height: 400px;
    width: 100%;
    border: 1px solid black;
    border-radius: 5px;
  }

  img.huechange {
    filter: hue-rotate(150deg);
  }
</style>
{% endblock extra_head %}
{% block content %}
<div class="container-fluid">
 <div class="row">
    <div class="col-md-6 order-md-last">
      <div id="map"></div>
    </div>

    <div class="col-md-6">
      <div class="accordion accordion-flush overflow-y-scroll" id="marker-region">
        {% if view == 'plants' %}
        <p>
          List of plant sites.
          View
          <a
            href="#"
            onclick="window.location.replace('{{ url_for('routes.collection_sites', view='collection') }}');"
          >collection sites</a>.
        </p>
        {% else %}
          <p>
          List of collection sites.
          View
          <a
            href="#"
            onclick="window.location.replace('{{ url_for('routes.collection_sites', view='plants') }}');"
          >plant sites</a>.
          </p>
        {% endif %}
        {% for data_row in markers %}
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}" aria-expanded="false" aria-controls="collapse{{ loop.index }}">
              {{ data_row['Site'] }} ({{ data_row['Abbreviation'] }})
            </button>
          </h2>
          <div id="collapse{{ loop.index }}" class="accordion-collapse collapse">
            <div class="accordion-body">
              <p>Information:</p>
              <ul class="list-group list-group-flush">
                <li class="list-group-item">
                  {{ data_row['County'] }}, {{ data_row['State'] }}
                </li>
                <li class="list-group-item">
                  Ecoregion (Level III): {{ data_row['Ecoregion (Level III)'] }}
                </li>
                <li class="list-group-item">
                  Ecoregion (Level IV): {{ data_row['Ecoregion (Level IV)'] }}
                </li>
                <li class="list-group-item">
                  Location: {{ data_row['Latitude'] }}&deg;N, {{ data_row['Longitude'] }}&deg;E
                </li>
              </ul>
              <button
                type="button"
                class="btn btn-secondary btn-sm mt-3"
                onclick="viewMapMarker({{ data_row['Latitude'] }}, {{ data_row['Longitude'] }})"
              >
                View on map
              </button>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<script>
  function set_map_table_height() {
      let window_height = window.innerHeight;
      let nav_height = document.querySelector('#site-navbar').offsetHeight;
      document.querySelector("#map").style.height = (
        window_height-nav_height-15
      ) + 'px';
      document.querySelector("#marker-region").style.height = (
        window_height-nav_height-15
      ) + 'px';
  }
  set_map_table_height();
  window.addEventListener('resize', set_map_table_height);

  let map = L.map('map', {
    "center": [38.047989, -84.501640],
    "zoom": 8,
  });

  let Esri_WorldImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
  });

  let Esri_WorldTopoMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
    attribution: 'Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ, TomTom, Intermap, iPC, USGS, FAO, NPS, NRCAN, GeoBase, Kadaster NL, Ordnance Survey, Esri Japan, METI, Esri China (Hong Kong), and the GIS User Community'
  });

  let Esri_WorldStreetMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
    attribution: 'Tiles &copy; Esri &mdash; Source: Esri, DeLorme, NAVTEQ, USGS, Intermap, iPC, NRCAN, Esri Japan, METI, Esri China (Hong Kong), Esri (Thailand), TomTom, 2012'
  });

  let ecoregions_geojson = {{ ecoregions_data|tojson }}; // GeoJSON, Object
  let gj_layer = L.geoJSON(ecoregions_geojson, {
    attribution: 'Ecoregions courtesy of Ian Horn via KyGovMaps Open Data Portal and the OpenGIS Project',
  }).addTo(map);

  let layerControl = L.control.layers(
    {
      "Topography": Esri_WorldTopoMap,
      "Satellite": Esri_WorldImagery,
      "Streets": Esri_WorldStreetMap,
    },
  ).addTo(map);
  layerControl.addOverlay(gj_layer, "Kentucky Ecoregions");

  Esri_WorldTopoMap.addTo(map);

  let markers = {{ markers|tojson }}; // Array of Objects
  let zoom_level = {{16 if view == 'plants' else 12}};

  let markers_arr = [];
  markers.forEach(function (item, index) {
    let marker = L.marker([item.Latitude, item.Longitude]).addTo(map);
    {{ 'marker._icon.classList.add("huechange");' | safe if view == 'plants' else '' }}
    marker.bindPopup(
      `${item.Site} (${item.Abbreviation})<br>${item.County} County, ${item.State}<br>(${item.Latitude}, ${item.Longitude})<br>Ecoregion (Level III): ${item['Ecoregion (Level III)']}<br>Ecoregion (Level IV): ${item['Ecoregion (Level IV)']}`
    );
    marker.on('click', () => map.flyTo(marker.getLatLng(), zoom_level));
    markers_arr.push(marker);
  });

  function viewMapMarker(lat, long) {
    let ll = L.latLng(lat, long)
    map.closePopup();
    map.flyTo(ll, zoom_level);
    for (let i in markers_arr) {
      if (markers_arr[i].getLatLng().equals(ll)) {
        markers_arr[i].openPopup();
        return;
      }
    }
  }
</script>
{% endblock content %}